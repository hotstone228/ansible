set firewall global-options state-policy established action 'accept'
set firewall global-options state-policy invalid action 'drop'
set firewall global-options state-policy related action 'accept'
set firewall group interface-group LAN interface 'eth1'
set firewall group interface-group VPN interface 'eth2'
set firewall group interface-group VPN interface 'eth5'
set firewall group interface-group VPN interface 'eth4'
set firewall group interface-group WAN interface 'eth0'
set firewall group network-group PRIVATE-NETS network '10.0.0.0/8'
set firewall group network-group PRIVATE-NETS network '172.16.0.0/12'
set firewall group network-group PRIVATE-NETS network '192.168.0.0/16'
set firewall group network-group PRIVATE-NETS network '127.0.0.0/8'
set firewall group network-group PRIVATE-NETS network '169.254.0.0/16'
set firewall group network-group PRIVATE-NETS network '224.0.0.0/4'
set firewall group network-group PRIVATE-NETS network '255.255.255.255/32'
set firewall group network-group PRIVATE-NETS network '100.64.0.0/10'
set firewall group network-group kv218-net network '192.168.20.0/24'
set firewall group network-group kv218-net network '192.168.60.0/24'
set firewall group network-group kv218-net network '192.168.61.0/24'
set firewall group network-group proxy-net network '192.168.100.0/24'
set firewall group network-group tailscale-net network '100.64.0.0/10'
set firewall group network-group zerotier-net network '10.121.15.0/24'
set firewall group port-group forwarded-ports port '80'
set firewall group port-group forwarded-ports port '443'
set firewall group port-group forwarded-ports port '9993'
set firewall ipv4 forward filter rule 90 action 'accept'
set firewall ipv4 forward filter rule 90 connection-status nat 'destination'
set firewall ipv4 forward filter rule 90 description 'Allow DNATed web'
set firewall ipv4 forward filter rule 90 state 'new'
set firewall ipv4 forward filter rule 100 action 'drop'
set firewall ipv4 forward filter rule 100 inbound-interface group 'WAN'
set firewall ipv4 input filter default-action 'drop'
set firewall ipv4 input filter rule 15 action 'accept'
set firewall ipv4 input filter rule 15 description 'VPN: allow all'
set firewall ipv4 input filter rule 15 inbound-interface group 'VPN'
set firewall ipv4 input filter rule 40 action 'accept'
set firewall ipv4 input filter rule 40 source group network-group 'kv218-net'
set firewall ipv4 input filter rule 50 action 'accept'
set firewall ipv4 input filter rule 50 source address '127.0.0.0/8'
set interfaces ethernet eth0 address 'dhcp'
set interfaces ethernet eth0 description 'WAN'
set interfaces ethernet eth0 hw-id '78:b2:13:a6:0e:a1'
set interfaces ethernet eth1 address '192.168.20.1/24'
set interfaces ethernet eth1 description 'LAN'
set interfaces ethernet eth1 hw-id 'bc:24:11:31:3f:fb'
set interfaces ethernet eth2 address '192.168.110.1/24'
set interfaces ethernet eth2 description 'proxy'
set interfaces ethernet eth2 hw-id 'bc:24:11:61:39:2e'
set interfaces ethernet eth3 address '192.168.111.1/24'
set interfaces ethernet eth3 description 'SecurityOnionManagment'
set interfaces ethernet eth3 hw-id 'bc:24:11:70:8a:54'
set interfaces ethernet eth4 address '192.168.60.1/24'
set interfaces ethernet eth4 description 'tailscale'
set interfaces ethernet eth4 hw-id 'bc:24:11:a7:5a:cf'
set interfaces ethernet eth5 address '192.168.61.1/24'
set interfaces ethernet eth5 description 'zerotier'
set interfaces ethernet eth5 hw-id 'bc:24:11:a4:27:c0'
set interfaces loopback lo
set load-balancing wan disable-source-nat
set load-balancing wan interface-health eth4 failure-count '3'
set load-balancing wan interface-health eth4 nexthop '192.168.60.2'
set load-balancing wan interface-health eth4 success-count '2'
set load-balancing wan interface-health eth4 test 0 target '100.64.0.6'
set load-balancing wan interface-health eth4 test 0 type 'ping'
set load-balancing wan interface-health eth5 failure-count '3'
set load-balancing wan interface-health eth5 nexthop '192.168.61.2'
set load-balancing wan interface-health eth5 success-count '2'
set load-balancing wan interface-health eth5 test 0 target '10.121.15.72'
set load-balancing wan interface-health eth5 test 0 type 'ping'
set load-balancing wan rule 10 destination address '192.168.10.0/24'
set load-balancing wan rule 10 failover
set load-balancing wan rule 10 inbound-interface 'eth1'
set load-balancing wan rule 10 interface eth4 weight '10'
set load-balancing wan rule 10 interface eth5 weight '1'
set nat destination rule 100 description 'HTTP+HTTPS → 192.168.20.39'
set nat destination rule 100 destination port '80,443'
set nat destination rule 100 inbound-interface group 'WAN'
set nat destination rule 100 protocol 'tcp_udp'
set nat destination rule 100 translation address '192.168.20.39'
set nat destination rule 110 description 'Hairpin: LAN → 192.168.20.39'
set nat destination rule 110 destination fqdn 'winvist.ru'
set nat destination rule 110 destination port '80,443'
set nat destination rule 110 inbound-interface group 'LAN'
set nat destination rule 110 protocol 'tcp_udp'
set nat destination rule 110 translation address '192.168.20.39'

set nat destination rule 200 description 'zerotier → 192.168.61.2'
set nat destination rule 200 destination port '9993'
set nat destination rule 200 inbound-interface group 'WAN'
set nat destination rule 200 protocol 'tcp_udp'
set nat destination rule 200 translation address '192.168.61.2'
set nat destination rule 210 description 'Hairpin: LAN → 192.168.61.2'
set nat destination rule 210 destination fqdn 'winvist.ru'
set nat destination rule 210 destination port '9993'
set nat destination rule 210 inbound-interface group 'LAN'
set nat destination rule 210 protocol 'tcp_udp'
set nat destination rule 210 translation address '192.168.61.2'

set nat source rule 100 outbound-interface group 'WAN'
set nat source rule 100 translation address 'masquerade'
set nat source rule 101 description 'NAT only 192.168.110.0/24 to 192.168.20.0/24'
set nat source rule 101 destination group network-group 'kv218-net'
set nat source rule 101 outbound-interface group 'LAN'
set nat source rule 101 source group network-group 'proxy-net'
set nat source rule 101 translation address 'masquerade'

set nat source rule 110 description 'Hairpin SRCNAT'
set nat source rule 110 destination address '192.168.20.39'
set nat source rule 110 outbound-interface group 'LAN'
set nat source rule 110 protocol 'tcp_udp'
set nat source rule 110 source group network-group 'kv218-net'
set nat source rule 110 translation address 'masquerade'

set policy route VPN-FORWARD interface 'eth1'
set policy route VPN-FORWARD rule 10 destination geoip country-code 'ru'
set policy route VPN-FORWARD rule 10 destination geoip inverse-match
set policy route VPN-FORWARD rule 10 destination group network-group '!PRIVATE-NETS'
set policy route VPN-FORWARD rule 10 destination port 'http,https,50000-65535'
set policy route VPN-FORWARD rule 10 protocol 'tcp_udp'
set policy route VPN-FORWARD rule 10 set table '100'
set policy route VPN-FORWARD rule 10 source group network-group 'kv218-net'
set protocols static route 10.121.15.0/24 next-hop 192.168.61.2
set protocols static route 100.64.0.0/10 next-hop 192.168.60.2
set protocols static table 100 route 0.0.0.0/0 next-hop 192.168.110.2
set service dns forwarding allow-from '0.0.0.0/0'
set service dns forwarding listen-address '192.168.20.1'
set service dns forwarding name-server 8.8.8.8
set service ntp allow-client address '0.0.0.0/0'
set service ntp server time1.vyos.net
set service ntp server time2.vyos.net
set service ntp server time3.vyos.net
set service ssh port '22'
set system config-management commit-revisions '100'
set system console device ttyS0
set system host-name 'kv218-vyos-master'
set system login user vyos authentication encrypted-password '$6$rounds=656000$CvidVEl1u8HmRFq0$n2SgptInPCL99CpCHzRn7FKZS1bI8s81nUZXehcy40VDlQhObup81j.7wHN2Jlkmk/mpFy8I1/sSNqLxNnoGn.'
set system login user vyos authentication plaintext-password ''
set system name-server 'eth0'
set system option reboot-on-upgrade-failure '5'
set system syslog local facility all level 'info'
set system syslog local facility local7 level 'debug'
set system time-zone 'Europe/Moscow'